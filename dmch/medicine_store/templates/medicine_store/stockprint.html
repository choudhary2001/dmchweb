{% extends 'counter/base.html' %} {% block css %}
<!-- CSS for Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
{% endblock %} {% block content %}
<!-- Begin Page Content -->
<div class="container-fluid">
  <!-- Page Heading -->
  <!-- <h1 class="h3 mb-2 text-gray-800">Staff</h1> -->
  {% if messages %} {% for message in messages %}
  <p {% if message.tags %} class="{{ message.tags }}" {% endif %} style="width: 90%; font-size: 1rem">{{ message }}</p>

  {% endfor %} {% endif %}
  <div style="display: flex"></div>
  <!-- DataTales Example -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <form action="{% url 'medicine_supply_details_view_print' %}" method="get" style="display: flex; flex-wrap: wrap; gap: 10px">
        <div style="flex: 1">
          <input type="date" id="start_date" class="form-control mb-2 mb-md-0" name="start_date" />
        </div>
        <div style="">
          <span>-</span>
        </div>
        <div style="flex: 1">
          <input type="date" id="end_date" class="form-control mb-2 mb-md-0" name="end_date" />
        </div>

        <!-- <div style="flex: 2">
            <select class="form-control" name="product_name" id="product_name" >
              <option value="">Select Medicine Name</option>
              <option value="All">All</option>
              {% for s in productsupply %}
              <option {% if department == s.productdetails_id %}selected{% endif %} value="{{ s.productdetails_id }}">{{ s.product_name }}</option>
              {% endfor %}
            </select>
          </div> -->

        <div class="form-group">
          <input type="text" class="form-control" id="searchInput" placeholder="Search..." />
        </div>
        <div style="flex: 1">
          <button class="btn btn-primary w-100" type="submit">Filter</button>
        </div>
        <div style="flex: 1">
          <button class="btn btn-primary w-100" onclick="printTable()">Print Table</button>
        </div>
        <div style="flex: 1">
          <a href="#;" class="btn btn-primary" onclick="exportToExcel()">Export to Excel</a>
        </div>
      </form>
    </div>

    <div class="card-body" id="printablecontent">
      <style>
        .table td {
          padding: 0.4rem !important;
          font-size: 0.8rem !important;
        }
      </style>
      <div class="card-header py-3" style="display: flex; flex-direction: column; align-items: center">
        <div><h2>Darbhanga Medical College and Hospital</h2></div>
        <div><h3>{{request.session.user_role}}</h3></div>
        <div><h3>Stock Report</h3></div>
        {% if start_date_str != None %}
        <div><h3>{{start_date_str}}</h3></div>
        {% endif %}
      </div>
      <div class="table-responsive" id="tableContainer">
        <table class="table table-bordered" id="datatablee" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>Department</th>
              <th>Product Type</th>
              <th>Product Name</th>
              <th>Mfg By</th>
              <th>Mfg Date</th>
              <th>Exp Date</th>
              <th>Batch No</th>
              <th>Opening</th>
              <th>Purchase</th>
              <th>Consumption</th>
              <th>Closing</th>
              <th>Remarks</th>
              <th>Supply On Date</th>
              <th>Created Date/Time</th>
            </tr>
          </thead>
          <tbody>
            {% for order in supply %} {% for product in order.products.all %}
            <tr>
              <td>{{ order.departpment.name }}</td>

              <td>
                <p>{{ product.product_type }}</p>
              </td>
              <td>
                <p>{{ product.product_name }}</p>
              </td>
              <td>
                <p>{{ product.mfg_name }}</p>
              </td>

              <td>
                <p>{% if product.mfg_date %}{{ product.mfg_date }}{% endif %}</p>
              </td>
              <td>
                <p>{% if product.exp_date %}{{ product.exp_date }}{% endif %}</p>
              </td>

              <td>
                <p>{{ product.batch_no }}</p>
              </td>
              <td>
                <p>{{ product.quantity }}</p>
              </td>
              <td>
                <p>{{ product.quantity }}</p>
              </td>
              <td class="quantity-difference"></td>
              <td>
                <p>{{ product.stock_quantity }}</p>
              </td>
              <!-- <td></td> -->
              <td>
                <p>{{ order.remarks }}</p>
              </td>
              <td>{{order.order_date|date:"j-m-Y"}}</td>
              <td>{{order.created_at}}</td>
            </tr>
            {% endfor %} {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block script %}
<!-- JavaScript for Select2 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
  // Function to print the table
  function printTable() {
    // Show the hidden print content
    // Print only the content inside the printContent div
    var printContents = $("#printablecontent").html();
    var originalContents = $("body").html();
    $("body").empty().html(printContents);

    // Trigger the print dialog
    window.print();
    $("body").html(originalContents);
  }
</script>

<script>
  $(document).ready(function () {
    $("#product_name").select2();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get all rows in the table body
    var rows = document.querySelectorAll("tbody tr");

    // Iterate over each row
    rows.forEach(function (row) {
      // Get the cells for quantity and stock quantity
      var quantityCell = row.querySelector("td:nth-child(9)");
      var stockQuantityCell = row.querySelector("td:nth-child(11)");
      var remainingStockCell = row.querySelector(".quantity-difference");
      console.log(quantityCell, stockQuantityCell, remainingStockCell);
      // Get the values from the cells
      var quantity = parseInt(quantityCell.textContent);
      var stockQuantity = parseInt(stockQuantityCell.textContent);

      // Calculate the remaining stock (difference)
      var remainingStock = quantity - stockQuantity;

      // Update the remaining stock cell with the calculated remaining stock
      remainingStockCell.textContent = remainingStock;
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get all rows in the table body
    var rows = document.querySelectorAll("tbody tr");

    // Object to store total stock for each product name
    var totalStock = {};

    // Iterate over each row
    rows.forEach(function (row) {
      // Get the cells for quantity, product name, and stock quantity
      var productNameCell = row.querySelector("td:nth-child(3)");
      var quantityCell = row.querySelector("td:nth-child(9)");
      var stockQuantityCell = row.querySelector("td:nth-child(11)");
      var remainingStockCell = row.querySelector(".quantity-difference");

      // Get the values from the cells
      var productName = productNameCell.textContent.trim();
      var quantity = parseInt(quantityCell.textContent);
      var stockQuantity = parseInt(stockQuantityCell.textContent);

      // Calculate the remaining stock (difference)
      var remainingStock = quantity - stockQuantity;

      // Update the remaining stock cell with the calculated remaining stock
      remainingStockCell.textContent = remainingStock;

      // Update total stock for the product name
      if (productName in totalStock) {
        totalStock[productName] += stockQuantity;
      } else {
        totalStock[productName] = stockQuantity;
      }
    });

    // Update Total Stock column
    var uniqueProducts = {}; // To keep track of processed product names
    rows.forEach(function (row) {
      var productNameCell = row.querySelector("td:nth-child(3)");
      var totalStockCell = row.querySelector("td:nth-child(11)");

      var productName = productNameCell.textContent.trim();
      if (!(productName in uniqueProducts)) {
        totalStockCell.textContent = totalStock[productName];
        uniqueProducts[productName] = true;
      } else {
        totalStockCell.textContent = ""; // Clear cell for duplicate product names
      }
    });
  });
</script>

<script>
  var filterActive = false;
  var initialTableRows = [];

  function sortTableByProductName() {
    if (filterActive) return;
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById("datatablee");
    switching = true;
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i <= rows.length - 1; i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName("td")[2];
        y = rows[i + 1].getElementsByTagName("td")[2];
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  function filterTable() {
    filterActive = true;
    var filter = document.getElementById("searchInput").value.toUpperCase();
    var table = document.getElementById("datatablee");
    var rows = table.getElementsByTagName("tr");

    for (var i = 1; i < rows.length; i++) {
      var productNameCell = rows[i].getElementsByTagName("td")[2];
      var productName = productNameCell ? productNameCell.textContent.toUpperCase() : "";
      if (productName.startsWith(filter)) {
        rows[i].style.display = "";
      } else {
        rows[i].style.display = "none";
      }
    }

    // Reset to initial sorted state if search input is cleared
    // if (!filter) {
    //   filterActive = false;
    //   resetTableToInitialState();
    // }
  }

  // function resetTableToInitialState() {
  //   var table = document.getElementById("datatablee").getElementsByTagName("tbody")[0];
  //   table.innerHTML = "";
  //   initialTableRows.forEach(function(row) {
  //     table.appendChild(row);
  //   });
  // }

  document.addEventListener("DOMContentLoaded", function () {
    var table = document.getElementById("datatablee");
    var rows = Array.from(table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"));
    initialTableRows = rows.slice(); // Store initial sorted state
    sortTableByProductName();
  });

  document.getElementById("searchInput").addEventListener("keyup", filterTable);
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Object to store aggregated data for each product name and batch number combination
    var aggregatedData = {};

    // Iterate over each row in the table body
    document.querySelectorAll("tbody tr").forEach(function (row) {
      // Get the cells for all columns
      var cells = row.querySelectorAll("td");

      // Extract data from cells
      var department = cells[0].textContent.trim() || " ";
      var productType = cells[1].textContent.trim() || " ";
      var productName = cells[2].textContent.trim() || " ";
      var mfgBy = cells[3].textContent.trim() || " ";
      var mfgDate = cells[4].textContent.trim() || " ";
      var expDate = cells[5].textContent.trim() || " ";
      var batchNo = cells[6].textContent.trim() || " ";
      var quantity = parseInt(cells[7].textContent) || 0;
      var consumption = parseInt(cells[9].textContent) || 0;
      var inStock = parseInt(cells[10].textContent) || 0;
      // var totalStock = parseInt(cells[10].textContent) || 0;
      var supplyDate = cells[11].textContent.trim() || " ";
      var createdDateTime = cells[12].textContent.trim() || " ";
      var remarks = cells[13].textContent.trim() || "";

      // Generate a unique key for each product name
      var key = productName;

      // Update aggregated data for the key
      if (key in aggregatedData) {
        // If the key already exists, update the aggregated data
        aggregatedData[key].quantity += quantity;
        aggregatedData[key].consumption += consumption;
        aggregatedData[key].inStock += inStock;
        // aggregatedData[key].totalStock += inStock; // Add inStock to totalStock
      } else {
        // If the key doesn't exist, initialize it with the current data
        aggregatedData[key] = {
          department: department,
          productType: productType,
          productName: productName,
          mfgBy: mfgBy,
          mfgDate: mfgDate,
          expDate: expDate,
          batchNo: batchNo,
          quantity: quantity,
          consumption: consumption,
          inStock: inStock,
          // totalStock: inStock, // Initialize totalStock with inStock
          supplyDate: supplyDate,
          createdDateTime: createdDateTime,
          remarks: remarks,
        };
      }
    });

    // Update the table with the aggregated data
    var tableBody = document.querySelector("tbody");
    tableBody.innerHTML = ""; // Clear existing table rows
    Object.keys(aggregatedData).forEach(function (key) {
      var rowData = aggregatedData[key];
      // Create a new row with the aggregated data
      var newRow = document.createElement("tr");
      newRow.innerHTML = `
        <td>${rowData.department}</td>
        <td>${rowData.productType}</td>
        <td>${rowData.productName}</td>
        <td>${rowData.mfgBy}</td>
        <td>${rowData.mfgDate}</td>
        <td>${rowData.expDate}</td>
        <td>${rowData.batchNo}</td>
        <td>${rowData.quantity}</td>
        <td>${rowData.quantity}</td>
        <td>${rowData.consumption}</td>
        <td>${rowData.inStock}</td>
        <td>${rowData.supplyDate}</td>
        <td>${rowData.createdDateTime}</td>
        <td>${rowData.remarks} </td>

      `;
      tableBody.appendChild(newRow);
    });
  });
</script>

<script>
  function exportToExcel() {
    var location = "data:application/vnd.ms-excel;base64,";
    var excelTemplate = "<html> " + "<head> " + '<meta http-equiv="content-type" content="text/plain; charset=UTF-8"/> ' + "</head> " + "<body> " + document.getElementById("printablecontent").innerHTML + "</body> " + "</html>";
    window.location.href = location + window.btoa(excelTemplate);
  }
</script>

<script>
  // Function to filter table rows based on search input
  // function filterTable() {
  //   // Get the search input value
  //   var filter = document.getElementById("searchInput").value.toUpperCase();
  //   // Get the table rows
  //   var rows = document.querySelector("#datatablee tbody").rows;

  //   // Loop through all table rows
  //   for (var i = 0; i < rows.length; i++) {
  //     var visible = false;
  //     // Loop through all cells in the current row
  //     for (var j = 0; j < rows[i].cells.length; j++) {
  //       var cell = rows[i].cells[j];
  //       // Check if the cell text matches the search query
  //       if (cell.textContent.toUpperCase().indexOf(filter) > -1) {
  //         visible = true;
  //         break;
  //       }
  //     }
  //     // Show or hide the row based on visibility
  //     if (visible) {
  //       rows[i].style.display = "";
  //     } else {
  //       rows[i].style.display = "none";
  //     }
  //   }
  // }

  // Add event listener to the search input field
  // document.getElementById("searchInput").addEventListener("keyup", filterTable);
</script>

{% endblock %}
